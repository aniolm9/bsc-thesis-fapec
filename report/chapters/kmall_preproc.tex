\chapter{KMALL Stage}

Recent advances in sonar technology and computing power have led to an improvement in ocean monitoring. For instance, Multibeam Echosounders (MBES) are now capable of collecting data from the water column, besides some usual metrics as seafloor reflectivity. This new information allows geoscientists to identify sunken structures, schools of fish, gas seeps, etc.

\begin{figure}[h!]
	\begin{center}
		  \begin{tabular}{ @{} c @{} }
			\includegraphics[scale=0.45]{images/mbes_ship.jpg}\\
			\imagesource{NOAA Photo Library, CC BY 2.0, via Wikimedia Commons.}
		\end{tabular}
	\end{center}
	\vspace*{-0.7em}
	\caption{Conception of multibeam sonar on NOAA Ship NANCY FOSTER.}
	\label{fig:mbes_ship}
\end{figure}

We clearly see that water column metrics have a big interest. However, their storage requirements are quite demanding (in the order of some GB/h). Hence, although it is possible to continuously record water column data, in practice it is only used in some specific explorations such as gas-seeps zones. In this scenario, efficient compression algorithms will be essential.

At the present moment, one of the biggest echosounder manufacturers is Kongsberg Maritime, a company with more than 7000 employees over 25 countries. In this chapter we will focus on the development of a preprocessing stage specially designed for the KMALL files from Kongsberg. First, a general overview of the data structures will be given. Then, with this format in mind, a design criterion will be proposed and implemented. Finally, we will analyze its performance and compare it with other compression algorithms.

\section{The KMALL data format} \label{sec:kmall_format}
In this section we will describe the KMALL data structure and why there is a need to develop new compression algorithms for this format, but first some concepts related to echosounders must be defined:
\begin{itemize}
	\item \textbf{Ping:} A ping is defined as a number of pulses transmitted at approximately the same time.
	\item \textbf{Beam:} Each ping is formed by some pulses in different angles, which we call beams.
\end{itemize}

Notice that the number of beams per ping depends on each sonar model, and the numbers of samples per beam depends on the angle and on the depth. This dependence can be seen in figure \ref{fig:wc_data}.

The .kmall format is a new format from Kongsberg which has just started being implemented in new echosounder models. It is the successor of the Kongsberg .all format. Analyzing the latter is out of the scope of this project, yet we can state some of the improvements that KMALL brings.

On the first hand, KMALL is a generic format with high resolution data and with a datagram structure designed to avoid breaking existing decoders when updating the data structure.

On the other hand, .all format used to have a datagram size constraint of 64 kB due to the maximum size of UDP packets, but .kmall files are designed to be stored "as is" and then fragmented if needed. Its main advantage is that pings are not splitted between datagrams.

The size of a .kmall file is not fixed. Actually, the echosounder operator decides when the file being recorded at that moment should end. In our dataset, most of the files are between 100 and 400 MB. Inside these files there are several datagrams, which will be described later in this section.

The mixture of data types in the same file makes it difficult for standard compressors like \textit{Zip} to identify data statistics, therefore they don't perform as good as one could expect. In order to improve the compression ratio, we are interested in knowing how are those datagrams placed inside the file and how to identify them. From Kongsberg KMALL documentation, we know that all datagrams start with a generic header that contains datagram size in bytes and a 4-character identifier. In the current version (410224 Revision H), there exist the following datagram types:

\begin{table}[H]
\normalsize
\centering
\begin{tabular}{|p{2cm}|p{3.5cm}|p{7.22cm}|}
		\hline
		\rowcolor[HTML]{9698ED} 
		\multicolumn{1}{|c|}{\cellcolor[HTML]{9698ED}Type code} & \multicolumn{1}{c|}{\cellcolor[HTML]{9698ED}Struct name} & \multicolumn{1}{c|}{\cellcolor[HTML]{9698ED}Description} \\ \hline
		\#CPO                                                   & EMdgmCPO\_def                                            & Compatibility (C) data for position (PO).                \\ \hline
		\#CHE                                                   & EMdgmCHE\_def                                            & Compatibility (C) data for heave (HE).                   \\ \hline
\end{tabular}
\caption{Compatibility datagrams of the KMALL format.}
\end{table}

\begin{table}[h!]
\normalsize
\centering
\begin{tabular}{|p{2cm}|p{3.5cm}|p{7.22cm}|}
	\hline
	\rowcolor[HTML]{9698ED} 
	\multicolumn{1}{|c|}{\cellcolor[HTML]{9698ED}Type code} & \multicolumn{1}{c|}{\cellcolor[HTML]{9698ED}Struct name} & \multicolumn{1}{c|}{\cellcolor[HTML]{9698ED}Description} \\ \hline
	\#IIP                                                   & EMdgmIIP\_def                                            & Installation and sensor parameters.                      \\ \hline
	\#IOP                                                   & EMdgmIOP\_def                                            & Runtime operator parameters.                             \\ \hline
	\#IBE                                                   & EMdgmIB\_def                                             & Built in test (BIST) error report.                       \\ \hline
	\#IBR                                                   & EMdgmIB\_def                                             & Built in test (BIST) reply.                              \\ \hline
	\#IBS                                                   & EMdgmIB\_def                                             & Built in test (BIST) short reply.                        \\ \hline
\end{tabular}
\caption{Installation and runtime datagrams of the KMALL format.}
\end{table}

\begin{table}[h!]
\normalsize
\centering
\begin{tabular}{|p{2cm}|p{3.5cm}|p{7.22cm}|}
	\hline
	\rowcolor[HTML]{9698ED} 
	\multicolumn{1}{|c|}{\cellcolor[HTML]{9698ED}Type code} & \multicolumn{1}{c|}{\cellcolor[HTML]{9698ED}Struct name} & \multicolumn{1}{c|}{\cellcolor[HTML]{9698ED}Description}                                              \\ \hline
	\#SPO                                                   & EMdgmSPO\_def                                            & Sensor (S) data for position (PO).                                                                    \\ \hline
	\#SKM                                                   & EMdgmSKM\_def                                            & Sensor (S) KM binary sensor format.                                                                   \\ \hline
	\#SVP                                                   & EMdgmSVP\_def                                            & \begin{tabular}[c]{@{}l@{}}Sensor (S) data from sound velocity (V)\\ profile (P) or CTD.\end{tabular} \\ \hline
	\#SVT                                                   & EMdgmSVT\_def                                            & \begin{tabular}[c]{@{}l@{}}Sensor (S) data for sound velocity (V)\\ at transducer (T).\end{tabular}   \\ \hline
	\#SCL                                                   & EMdgmSCL\_def                                            & Sensor (S) data from clock (CL).                                                                      \\ \hline
	\#SDE                                                   & EMdgmSDE\_def                                            & Sensor (S) data from depth (DE) sensor.                                                               \\ \hline
	\#SHI                                                   & EMdgmSHI\_def                                            & Sensor (S) data for height (HI).                                                                      \\ \hline
\end{tabular}
\caption{External sensor output datagrams of the KMALL format.}
\end{table}

\begin{table}[h!]
\normalsize
\centering
\begin{tabular}{|p{2cm}|p{3.5cm}|p{7.22cm}|}
	\hline
	\rowcolor[HTML]{9698ED}
	\multicolumn{1}{|c|}{\cellcolor[HTML]{9698ED}Type code} & \multicolumn{1}{c|}{\cellcolor[HTML]{9698ED}Struct name} & \multicolumn{1}{c|}{\cellcolor[HTML]{9698ED}Description} \\ \hline
	\#FCF                                                   & EMdgmFCF\_def                                            & \begin{tabular}[c]{@{}l@{}}Backscatter calibration (C) file (F) \\ datagram.\end{tabular}   \\ \hline
\end{tabular}
\caption{File datagrams of the KMALL format.}
\end{table}

\begin{table}[h!]
\normalsize
\centering
\begin{tabular}{|p{2cm}|p{3.5cm}|p{7.22cm}|}
		\hline
		\rowcolor[HTML]{9698ED} 
		\multicolumn{1}{|c|}{\cellcolor[HTML]{9698ED}Type code} & \multicolumn{1}{c|}{\cellcolor[HTML]{9698ED}Struct name} & \multicolumn{1}{c|}{\cellcolor[HTML]{9698ED}Description}                                      \\ \hline
		\#MRZ                                                   & EMdgmMRZ\_def                                            & \begin{tabular}[c]{@{}l@{}}Multibeam (M) raw range (R)\\ and depth (Z) datagram.\end{tabular} \\ \hline
		\#MWC                                                   & EMdgmMWC\_def                                            & \begin{tabular}[c]{@{}l@{}}Multibeam (M) water (W)\\ column (C) datagram.\end{tabular}        \\ \hline
\end{tabular}
\caption{Multibeam datagrams of the KMALL format.}
\end{table}

It is important to notice that .kmall files can contain all the above datagrams. However, we may usually find that water column data is logged in a separate file with extension .kmwcd. In other words, MWC datagrams will be stored in .kmwcd files instead of .kmall files, but the decoding process is the same for both extensions as the data format is exactly the same.

As we will see in the next section, our main interest in this chapter will lie in \acrshort{mwc} datagrams. Therefore, before continuing, an appropriate description of them shall be given.

\pagebreak
\acrshort{mwc} datagrams are structured as follows:

\begin{figure}[h!]
	\begin{center}
		\scalebox{.565}{\input{images/mwc_datagram.tex}}
	\end{center}
	\caption{MWC datagram as described by Kongsberg (410224 Revision H).}
	\label{fig:mwc_datagram}
\end{figure}
Where:
\begin{description}
	\item $N_B \equiv$ Number of beams in ping. It is stored as a 16-bit integer in \textit{RxInfo}.
	\item $N_S \equiv$ Number of samples in beam. It is stored as a 16-bit integer in \textit{BeamData}.
	\item $phaseFlag \equiv$ Flag that indicates if there is phase information after amplitude samples. It may be 0 (no phase information), 1 (8-bit resolution) or 2 (16-bit resolution). It is stored as an 8-bit integer in \textit{RxInfo}.
\end{description}

In the present work we will only use information contained in \textit{Header} such as the datagram size, in \textit{RxInfo} and in \textit{BeamData}. For further details, the interested reader may check reference \parencite{KMALL}.

\section{Design}
\begin{comment}
Faré tres subseccions: Requirements, Data analysis, Algorithm design.

A la primera posaré els requeriments que vam posar al project plan, a la segona justificaré per què només comprimim el MWC i a la 3a descriuré l'algoritme escollit.
\end{comment}

In the previous section we introduced the KMALL data format. Namely, we saw that it is a mixture of different data types, so we have to decide which ones should be compressed and which algorithm will be applied.

In order to decide what to compress, we have first analyzed some .kmall and .kmwcd to determine the percentage of occupancy by datagram type. For the former files, we found that MRZ datagrams are a 92\% of the total size; and for the later, MWC datagrams are a 99\%. It is clear that these two data types are our objective; however, in this thesis we will ignore MRZ datagrams and we will just focus on MWC data. Actually, if we look at figure \ref{fig:mwc_datagram} we see that MWC headers are insignificant compared to its samples, therefore we will only compress payload information.

\begin{figure}[h!]
	\begin{center}
		\includegraphics[scale=0.3]{images/water_column_data.png}
	\end{center}
	\caption{Raw image representation of water column data captured by a Kongsberg EM 2040 echosounder.}
	\label{fig:wc_data}
\end{figure}

Once we have decided that we will restrict to water column data, a design criteria must be properly defined. This design has to take into account multiple aspects, namely: speed, implementation easiness and compression performance.

In previous chapters we explained that FAPEC compresses files by breaking them into chunks and processing each of them individually. This feature may be dangerous in our datagram scenario, so our first criterion will be to avoid FAPEC from splitting datagrams into different chunks. This way, the implementation will be much easier at the cost of reducing the process performance.

\begin{comment}
\parencite{Portell2019}
\end{comment}

\section{Implementation}
\begin{comment}
Same que wave. Explicació + flowchart, sense codi.
\end{comment}

\section{Results}
\begin{comment}
Same que al wave. Histogrames, negentropy i diagrama.
\end{comment}